const DEFAULT_FPS=1e3;class PRIVATE extends WeakMap{constructor(){super();let a=this;return function(b){let c,d=a.get(b)||(c={});return c&&a.set(b,d)&&d||d}}}class DrawBuffer extends Array{constructor(a){return super(),this.interval=Math.floor(1e3/(a||DEFAULT_FPS)),this.then=this.now=Date.now(),this.stopped=!1,this.now=!1,this}start(){if(!this.length)return!1;requestAnimationFrame(this.start.bind(this)),this.now=Date.now();let a=this.now-this.then;if(a>this.interval&&S){this.then=this.now-a%this.interval;let b=this.shift();S.send(b).then()}}stop(){return this.stopped=!0}queue(a){a&&this.push(a),this.start(!0)}}class Player{constructor(a){return this.element=this.e=a,this.e.instance=this,this.element.on('mouseover',()=>$(pencil).hide('fast')),this}get name(){return this.e.children('name').html()}says(a){a=a&&Promise.resolve(a),a.then((a)=>{M.add({from:this.name,content:a})})}}class Messenger{constructor(){this.messages=$('#messages')}add(a){let b=new Date,c=b.getHours()+':'+('0'+b.getMinutes()).slice(-2)+':'+('0'+b.getSeconds()).slice(-2),d=$(`<message from="${a.from}" timestamp="${c}">`);d.html(a.content).prependTo(this.messages),this.cleanup()}cleanup(){let a=this.messages.children().toArray();a.splice(-10),this.messages.get(0).scrollTo(0,this.messages.height()),a.forEach((a)=>a.remove())}}class Socket{constructor(){let a=P(this).ws=new WebSocket('ws://'+appURL.hostname+'/api');this.guid=guid(),this.pending={},a.addEventListener('open',this.onopen.bind(this)),a.addEventListener('close',this.onclose.bind(this)),a.addEventListener('message',this.onmessage.bind(this))}onopen(){}onclose(){}onmessage({data:a}){if(!/^[\[|\{]/.test(a))return console.warn('Invalid message received');a=JSON.parse(a);let b;a.mid&&(b=this.pending[a.mid])?b.done(a):Object.keys(a).forEach((b)=>{let c=a[b];'function'==typeof this['on'+b.toLowerCase()]&&this['on'+b.toLowerCase()](c);let d=new CustomEvent(b.toLowerCase(),{detail:c});window.dispatchEvent(d)})}onguid(a){this.guid=a}send(a){if(!P(this).ws.readyState)return Promise.resolve(!1);let b=(()=>{let a,b=new Promise((b)=>a=b);return{done:a,promise:b}})(),c=Math.round(64000000*Math.random()),d=P(this).ws;return this.pending[c]=b,a&&(Array.isArray(a)||a.hasOwnProperty||'string'==typeof a&&!/^[\[|\{]/.test(a))?(a.mid=c,a.guid=this.guid,a=JSON.stringify(a),d.readyState&&d.send(a)):console.warn('Invalid data'),b.promise}}const P=new PRIVATE,M=new Messenger,S=new Socket;